{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block content %}

<style>
/* Style for messages sent by the current user */
.message-right {
    margin-right: 10px;
    margin-left: 20rem;
    text-align: right;
    display: flex;
    justify-content: flex-end;
}

/* Style for messages sent by other users */
.message-left {
    margin-left: 10px;
    margin-right: 20rem;
    text-align: left;
    display: flex;
    justify-content: flex-start;
}

/* Additional styling for the chat log */
.chat-log {
    border: none;
    resize: none;
    overflow-y: scroll; /* Enable vertical scrolling */
}

/* Style for the card messages */
.card-message {
    margin-bottom: 10px;
}

/* Style for the timestamp */
.text-muted {
    font-size: 0.8em;
    color: grey;
}

#chat-log-history {
padding: 10px;
overflow-y: auto;
}

/* Full height container to fit the viewport */
.full-height {
    height: 75vh;
    display: flex;
    flex-direction: column;
}

/* Adjustments for smaller screens */
@media (max-width: 1200px) {
    .message-right, .message-left {
        margin-left: 5%;
        margin-right: 5%;
    }
    .card-message {
        max-width: 90%;
    }
}

@media (max-width: 768px) {
    .message-right, .message-left {
        margin-left: 2%;
        margin-right: 2%;
    }
    .card-message {
        max-width: 96%;
    }
}

</style>

<div class="card full-height">
    <div class="header">
        <h4 class="card-title m-3">{{ receiver.username }}</h4>
    </div>
    <div id="chat-log-history" class="card" style="overflow-y: auto;">
        {% for chat in previous_chats %}
        <div class="card-message {% if chat.sender_id == request.user.id %}message-right float-right{% else %}message-left float-left{% endif %}">
            <div class="card {% if chat.sender_id == request.user.id %}message-right float-right bg-secondary text-white {% else %}message-left float-left bg-light {% endif %}">
                <div class="card-body p-2">
                    <div class="card-title">
                    {{ chat.message }}
                    </div>
                    <small class="{% if chat.sender_id == request.user.id %}text-white{% endif %}">
                        {{ chat.timestamp }}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}

        <div id="chat-log" class="chat-log">
            <!-- Messages will be appended here -->
        </div>
    </div>
</div>

<div>
    <form>
        <div class="input-group">
            <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message">

            <button id="chat-message-submit" class="btn btn-primary" type="submit">Send</button>

        </div>
    </form>
</div>


{{ receiver.id|json_script:"receiver_id" }}
{{ request.user.id|json_script:"sender_id" }}
<script>
    receiver_id = JSON.parse(document.getElementById("receiver_id").textContent)
    var ws = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + receiver_id + '/'
    );

    function formatTimestamp(isoString) {
        const date = new Date(isoString);

        const months = ["Jan.", "Feb.", "Mar.", "Apr.", "May", "Jun.", "Jul.", "Aug.", "Sep.", "Oct.", "Nov.", "Dec."];
        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();
        let hours = date.getHours();
        const minutes = date.getMinutes();
        const isPM = hours >= 12;

        // Convert 24-hour time to 12-hour time
        hours = hours % 12 || 12;

        // Format minutes with leading zero if necessary
        const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;

        // Format time
        const time = `${hours}:${formattedMinutes} ${isPM ? 'p.m.' : 'a.m.'}`;

        // Combine formatted date and time
        return `${month} ${day}, ${year}, ${time}`;
    }

    ws.onopen = function () {
        console.log('WebSocket Connection Open...')
    };

    ws.onmessage = function (event) {
        console.log("Message received from server...", event.data)
        const data = JSON.parse(event.data)
        console.log("Data...", data)

        // Determine the class based on the sender
        const isSender = data.sender_id === JSON.parse(document.getElementById("sender_id").textContent);
        const messageClass = isSender ? 'message-right float-right' : 'message-left float-left';
        const cardClass = isSender ? 'message-right float-right bg-secondary text-white' : 'message-left float-left bg-light';
        const textClass = isSender ? 'text-white' : 'text-muted';

        // Create a new div element with the appropriate class and message content
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('card-message', ...messageClass.split(' '));

        // Add message card
        const cardDiv = document.createElement('div');
        cardDiv.classList.add('card', ...cardClass.split(' '));

        // Add card body
        const cardBody = document.createElement('div');
        cardBody.classList.add('card-body', 'p-2');

        // Add card title with the message content
        const cardTitle = document.createElement('div');
        cardTitle.classList.add('card-title');
        cardTitle.textContent = data.message;

        // Add timestamp
        const timestamp = document.createElement('small');
        timestamp.classList.add(...textClass.split(' '));
        timestamp.textContent = formatTimestamp(data.timestamp);

        // Append message and timestamp to card body
        cardBody.appendChild(cardTitle);
        cardBody.appendChild(timestamp);

        // Append card body to card
        cardDiv.appendChild(cardBody);

        // Append card to message div
        messageDiv.appendChild(cardDiv);

        // Append the message to the chat log
        document.querySelector('#chat-log-history').appendChild(messageDiv);

        // Scroll to the bottom of the chat log
        document.querySelector('#chat-log-history').scrollTop = document.querySelector('#chat-log-history').scrollHeight;
    }

    document.querySelectorAll('.chat-timestamp').forEach(function(element) {
        const isoString = element.getAttribute('data-timestamp');
        element.textContent = formatTimestamp(isoString);
    });

    var objDiv = document.getElementById("chat-log-history");
    objDiv.scrollTop = objDiv.scrollHeight;

    document.getElementById("chat-message-submit").onclick = function (event) {
        const messageInputDom = document.getElementById("chat-message-input")
        const message = messageInputDom.value
        console.log(message)
        ws.send(JSON.stringify({
            'message': message,
        }))
        messageInputDom.value = '';
        return false;
    }
</script>

{% endblock content %}
